
<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="abcjs_basic_2.3-min.js" type="text/javascript"></script>
	<script src="parser.js" type="text/javascript"></script>
	<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>


	<script type="text/javascript">

    var OCTAVE = 12;
	var MEASURE_LENGTH_PADDING = 2;
    var seed;
    var timeNumerator = 4;
    var timeDenominator = 4;
    var clef = "treble";
    var minMeasures = 0;
    var maxMeasures = 0;
    var absMinPitch = 0;
    var absMaxPitch = 127;
    var lineLength = 25;
    var startKey = 'C';
    var noteLengths = ['q'];
    var noteLetters = ['A,,,,', 'B,,,,','C,,,', 'D,,,', 'E,,,', 'F,,,', 'G,,,', 'A,,,', 'B,,,','C,,', 'D,,', 'E,,', 'F,,', 'G,,', 'A,,', 'B,,','C,', 'D,', 'E,', 'F,', 'G,', 'A,', 'B,', 'C', 'D', 'E', 'F', 'G', 'A', 'B', 'c', 'd', 'e', 'f', 'g', 'a', 'b', "c'", "d'", "e'", "f'", "g'", "a'", "b'", "c''", "d'", "e''", "f'", "g''", "a''", "b''", "c'''"];

    var letterVals = {
        "C": 0,
        "D": 2,
        "E": 4,
        "F": 5,
        "G": 7,
        "A": 9,
        "B": 11
    };

    var notesSharps = ["C", "^C", 'D', '^D', 'E', "F", "^F", "G", "^G", "A", "^A", "B"];
    var notesFlats = ["C", "_D", 'D', '_E', 'E', "F", "_G", "G", "_A", "A", "_B", "B"];


    //var keys = ['A','B','C','D','E','F','G'];

    //returns a random number between 0 and bound.
    function randInt(bound) {
        return Math.floor(Math.random() * (bound));
    }

    //@pre: note is a string of the format "LETTER (A-G) + (#* OR b*) + NUMBER (0-8)," eg C#4 or D2.
    function sciToMidi(note){
        var letter = note.charAt(0).toUpperCase();
        var octave = parseInt(note.charAt(note.length-1));
        var symbols = note.substring(1, note.length-1);

        var midi = 0;
        midi = (octave + 1) * OCTAVE + letterVals[letter];

        //assumes that we have only sharps OR only flats in 'symbols' (never both sharps and flats).
        if (symbols.length > 0){

            //add 1 for every sharp
            if (symbols.charAt(0) == '#') {
                midi = midi + symbols.length;
            }

            //subtract 1 for every flat
            else if (symbols.charAt(0) == 'b'){
                midi = midi - symbols.length;
            }
        }
        return midi;
    }

    function midiToAbc(midi){
        var abcString;
        if (randInt(2) == 0) {
            abcString = notesSharps[midi % 12];
        }
        else {
            abcString = notesFlats[midi%12];
        }
        var octave = Math.floor((midi-60)/12);

        var symbol;
        if (octave > 0){
            symbol = "'"; //higher than middle C octave
        }
        else {
            symbol = ","; //lower or equal to middle C octave
        }
        
        octave = Math.abs(octave);
        
        while (octave > 0){
            octave--;
            abcString = abcString + symbol;
        }

        return abcString;
    }

    //generates and renders piece based on current parameters
    function generate(){

        presets();

        //parse
        var parseSuccess = true;
        try {
            parse();
        }
        catch(err) {
            $("#error").html(err.name + ": " + err.message);
            console.log(err);
            parseSuccess = false;
        }

        //generate ABC string and render it
        if (parseSuccess){
            setup();
            ABCJS.renderAbc('notation', genABC());
        }
    }

    function setup(){

    }

    function presets(){

        //clear out prev sheet music
        $("#notation").html("");

        //clear out any error messages
        $("#error").html("");

        clef = "treble";

        absMinPitch = sciToMidi("G3");
        absMaxPitch = sciToMidi("C6");
    }

    //parses whatever's in the #input text area with parser.parse().  sets appropriate parameters based on data received from parsing.
    function parse(){
    	var data = parser.parse($('textarea#input').val());
    	
    	//number of measures.  either array (when user enters a min/max range) or an int.
        if (data.numMeasures != null){
            if (data.numMeasures.constructor === Array){
               minMeasures = data.numMeasures[0];
               maxMeasures = data.numMeasures[1];
            }
            else {
                minMeasures = data.numMeasures;
                maxMeasures = data.numMeasures;
            }
        }

        //starting key
        if (data.key != null){
            startKey = data.key;
        }

        //seed
        if (data.seed != null){
            seed = data.seed;
        }
        else {
            var randSeed = Math.random().toString(36).substr(2, 5);
            seed = randSeed;
        }
        Math.seedrandom(seed);
        $("#seed").html(seed);

        //clef
        if (data.clef != null){
            clef = data.clef;
        }

        //absolute min/max pitch
        if (data.absRange != null){
            absMinPitch = data.absRange[0];
            absMaxPitch = data.absRange[1];
        }
    }

    function genABC(){
        var genString ="M: " + timeNumerator + "/" + timeDenominator + "\n";
        genString = genString + "L: 1/4 \n"
        genString = genString + "K: " + startKey + " " + clef + "\n"

        var m = randInt(maxMeasures - minMeasures + 1) + minMeasures;
        var curLineLength = 0; //current number of notes in line (to keep track of when to start new line)
        while (m > 0){
            var measure = genMeasure();
            m--;
            genString = genString + measure.measureString;
            curLineLength += measure.numNotes;

            //start new line if we're past lineLength
            if (curLineLength >= lineLength){
                curLineLength = 0;
                genString = genString + "\n";
            }
        }
        return genString;
    }

    //returns an object that wraps two elements: measureString, numNotes
    function genMeasure(){

    	var measureString = "";
    	var n = 4;
    	var numNotes = 0;
    	while (n > 0){
    		n--;
    		measureString = measureString + " " + genRandomNote();
    		numNotes++;  //increment numNotes every time we add a note.
    	}
    	measureString = measureString + " |";
    	numNotes += MEASURE_LENGTH_PADDING;
    	return {
    		measureString: measureString, 
    		numNotes: numNotes
    	};
    }

    //TODO: potential infinite loop if user enters SMALL abs pitch range and LARGE poly.
    //generates random note (can be a chord as well) within abs pitch range.
    function genRandomNote(){
        var noteString = "[";

        //num of notes in chord
        var poly = getPoly();

        //stores midi representation of notes
        var notes = [];

        //add notes 'poly' times
        while (poly > 0){
            poly--;
            
            //loop until we find a note that isn't in note array yet
            var posNote = randInt(absMaxPitch - absMinPitch + 1) + absMinPitch;
            while (notes.indexOf(posNote) > -1){
                posNote = randInt(absMaxPitch - absMinPitch + 1) + absMinPitch;
            }
            notes[notes.length] = posNote;
        }

        //create string from midi notes in 'note' array
        for (var i = 0; i < notes.length; i++){
            noteString = noteString + midiToAbc(notes[i]);
        }
        noteString = noteString + "]";
        return noteString;
    }

    function getPoly(){
        return randInt(3) + 1;
    }

    </script>

    
    <a href="#" onclick="generate()" >GENERATE  </a>
    <p>Seed: <span id ="seed"></span> <br> <span id = "error"></span></p>


    <textarea id="input">measures: 10</textarea>

    <div id="notation"></div>

</body>
</html>